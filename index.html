<html>
  <style>

    .background {
      fill: none;
      pointer-events: all;
    }

    #countries{
      fill: #aaa;
    }


    #country-borders {
      fill: none;
      stroke: #fff;
      stroke-width: 1px;
      stroke-linejoin: round;
      stroke-linecap: round;
      pointer-events: none;
    }
   .label {
      font-size:10pt;
    }
    .axis path {fill: none; stroke: black;}
    .axis line {stroke:black;}
    .axis text {font-size: 8pt;}
    table, th, td {
      border: 1px solid black;
    }

    .background {
      fill:none;
    }

    .p8line {
      fill:none;
      stroke: black;
      stroke-width:5;
    }

  </style>

  <head>
    <title>
      INFO 3300 Project 2
    </title>
    <script src = "http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <script src = "http://d3js.org/topojson.v1.min.js" charset="utf-8"></script>
    <script src = "http://d3js.org/queue.v1.min.js" charset="utf-8"></script>
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
    <link rel="stylesheet" type="text/css" href="custom.css">
    <link rel="stylesheet" type="text/css" href="button.css">

    <!-- Load fonts-->
    <link href='https://fonts.googleapis.com/css?family=Lato&subset=latin,latin-ext' rel='stylesheet' type='text/css'>

  </head>

    <script>

    </script>

  <body>
    <div class="title">
      <h1>Economic Progress, Human Development, and Gender Inequality in Today's World</h1>
      <h4> Exploring how human development and economic progress are intricately
        linked using data from the United Nations and the World Bank, the authors
        construct a series of visualizations to depict the correlated growth
        of socio and economic factors.</h4>
      <h4>By: Jeff Baum (jtb93), Shangyuan Niu (sn522), Yuxiao Tan (yt358)
      </h4>
    </div>
    <div id="top">
      <h2> World by Inequality Adjusted Human Development Index</h2>
	      <p>
        Inequality-adjusted Human Development Index (IHDI), is a measure of
        a country's development that summarizes health, education, standard of
        living, and equality indicators. Its inception is anchored on the work
        of Nobel laureate Amartya Sen's work. Every year the United Nations
        Development Programme publishes these numbers as an indicator
        that ranks the world into four tiers of human development. <br><br>

        When the world is divided into Best, Decent, Bad, and Worst countries, as
        according to IHDI, we see a spread similar to the Three-World Model
        extending from the Cold War. <br>

        We see that the First World bloc (United States + Western Europe)
        shares very high values of IHDI, Second World bloc (Brazil, China, India +
        Eastern Europe) share Decent to Bad level of IHDI, and the Third World
        block share the Worst level of IHDI.<br>
	</p>

      <div id="firstmap"></div>
      <div id="firstmapdata">
        <!-- FMD means FirstMapData -->
        <div id="fmd_title">
          Click on many countries!
        </div>

        <div id= "fmd_ranking"></div>
        <div id="fmd_info">
          <div id="fmd_ihdi">
          </div>
          <div id="fmd_hdi">
          </div>
        </div>
        <div id="fmd_button">
          <div class="toggle-button">
            <button></button>
          </div>
          <div class="toggle-button-text">Show All On Map</div>
        </div>

      </div>
    </div>

    <div id = "middle">
      <h2> World by Gender Inequality Index</h2>
      <p>
      Gender Inequality Index (GII), measures gender inequalities
      in three important aspects of human development: <br>
      1) reproductive health, measured by maternal mortality ratio and
      adolescent birth rates <br>

      2) empowerment, measured by proportion of parliamentary seats occupied by
      females 25+ <br>

      3) female economic status, expressed as labour market participation and
      measured by labour force participation rate of females 15 + <br> <br>

      <b> Author's Note: </b> The higher a country's GII is, the <b>worse</b> its
      gender inequality is. This is different than the IHDI, where the <b> better </b>
      the IHDI, the more equal the country is as a whole. <br><br>

      If you observe the GII graph, it resembles the IHDI graph from the
      previous section. We conclude that gender inequality and human
      development equality are highly correlated.<br>
      However, we do see that for gender inequality, certain countries
      (USA and Canada) are categorized similarly to the Second-World bloc, as
      opposed to the First-World bloc. <br>
      With respect to historical as well as current political context, this
      result is not surprising.

	</p>

      <div id = "middlemap"></div>
      <div id = "middlegraph">
        <h3> Gender Inequality Scores</h3>
        <p> Smaller means less inequality.</p>
      </div>
    </div>

    <div id="bubble">
      <h2> GDP Bubble Chart </h2>
      <p>
        Gross Domestic Product (GDP), measures the value of all goods and services
        produced in a period by a country. We present to you a visualization of
        the GDP of the main players of the world from the Cold War until the
        modern times. <br><br>

        Since after World War II, the United States have become the largest
        GDP in the world and continues to be so up to this day. <br>

        An interesting correlation to observe is the rise of BRIC (Brazil,
        Russia, India, China) over the last 20 years. <br> These countries'
        IHDI has risen to a value near the best of the Western countries,
        whereas their GII has not risen. An hypothesis, proposed by a recent
        paper by the Oxfam Foundation (studies inequality and poverty),
        is the abundance of male labor forces. <br><br>

        This is justified by our data, as we see that China does better than India in GII.
        Limited by the One Child Policy, China's working class is waning as the
        older generation is retiring. <br> This forces the female working class
        to rise to compensate for the lack of the male working class. India,
        without population control, does not share this feature. <br>


	</p>

      <div id = "bubblegraph"></div>
      <div id = "bubblesliderwrap">
        Data From Year : <br>
        <div id="bubbleamount">1975</div>
        <div id="bubble-slider-range"></div>
    </div>
    </div>

    <div id="gdp">
      <h2> Log of GDP per capita vs HDI </h2>
      <p>
      Human Development Index(HDI), is the brother dataset to the IHDI dataset that
      we have been working with throughout this visualization. It is the
      dataset measuring pure human development, without regards to the
      introduction (or removal) of inequality. <br><br>

      When we map this dataset against the GDP of countries in the last 40 years, there
      is a strong correlation that presents itself. <br> We see that no matter
      which year, there is a trend of higher GDP per capita, then higher HDI.
      However, in recent years, we see that the correlation grows stronger. <br> We
      observe this due to the fact that the points cluster more onto a line and
      the value of deviation from the best-fit line is much smaller than previous.

	</p>
      <div id = "gdpgraph"></div>
      <div id = "gdpsliderwrap">
        Data From Year : <br>
        <div id="amount">1975</div>
        <div id="slider-range"></div>
      </div>
    </div>

    <div id="conclusion">
      <h2> Conclusion </h2>
      <p>
      In conclusion, we have shown with our multitude of datasets that
      human development, human equality, and gender equality, are all highly
      correlated to the GDPs of countries. <br><br>

      With high economic growth comes a high demand for a middle and working
      class, and thus a higher demand for intelligence, regardless of
      upbringing, gender, and socioeconomic status at birth. <br>

      There were three main points we strived to present throughout our
      visualizations: <br><br>
      1) Cold War Era designation of the Three-World Bloc continues to
      influence the human inequality to this day (despite 26 years after the
      fall of USSR)<br>
      2) Gender Inequality is correlated to the Cold War Era split, but also
      correlated to regional politics (USA/Canada less gender friendly than
      Western Europe) <br>
      3) Over time, countries get better and better in terms
      of gender equality, as long as their GDP continues to grow <br>

      </p>
    </div>
    <script>

    var width = 740,
    height = 550,
    centered;

    var q = queue(4);

    var projection = d3.geo.mercator()
    .scale(125)
    .translate([width/2, height/2])
    ;

    var path = d3.geo.path()
    .projection(projection);

    var svg = d3.select("#firstmap").append("svg")
    .attr("width", width)
    .attr("height", height);

    svg.append("rect")
    .attr("class", "background")
    .attr("width", width)
    .attr("height", height)
    .on("click", clicked);

    var tooltip = d3.select("body").append("div").attr("class", "tooltip").style("opacity", 0);

    var g = svg.append("g");
    var idMap = {};
    var ihdi = {};
    var hdi = {};
    var hdi2 = {};
    var gii = {};
    var gdp = {};

    //
    //
    //
    // Pre-Load Actions: This is what happens before humans can interact
    // with the page
    //
    //
    //

    // Reading ID -> Countries
    function readCountryNames() {
      d3.tsv("names.csv", function(data){
        for(var i = 0;i < data.length; i++) {
          idMap[data[i].id] = data[i].name;
        }
        loadIHDI();
      });
    }

    readCountryNames();

    // Loads the World Map
    function loadWorld() {
      return d3.json("world.json", function(error, world) {
        if (error) throw error;

        g.append("g")
        .attr("id", "countries")
        .selectAll("path")
        .data(topojson.feature(world, world.objects.countries).features)
        .enter().append("path")
        .attr("d", path)
        .on("click", clicked)
        .on("mouseover", function(d) {
            var tempCountryName = idMap[d.id];

            var tempString = ihdi[tempCountryName] ?
                ("World Ranking: " + ihdi[tempCountryName]["Ranking"] + " <br>"
                + "IHDI Score: " + ihdi[tempCountryName]["2014"] + " <br>") : "No Data Present";
            tooltip .style("opacity", .7);
                tooltip.html(tempCountryName + " <br><br>" + tempString)
                .style("left", (d3.event.pageX) + "px")
                .style("top", (d3.event.pageY - 85) + "px");
            })
            .on("mouseout", function(){
                tooltip .style("opacity", 0).style("left",0) .style("top", 0);
              });

        g.append("path")
        .datum(topojson.mesh(world, world.objects.countries, function(a, b) { return a !== b; }))
        .attr("id", "country-borders")
        .attr("d", path);

      var legendRectSize = 14;
      var legendSpacing = 4;
      var colors = ["#a6a6a6", "#85D9FF", "#2DA0E9", "#2B4FEC", "#02197D"].reverse();
      var colorNames = ["No Data", "Worst", "Bad", "Decent", "Best"].reverse();

      var legend = svg.selectAll('.legend')
      .data(colors)
      .enter()
      .append('g')
      .attr('class', 'legend')
      .attr('transform', 'translate(50,400)');

      for (var i = 0; i < colors.length; i ++){
      legend.append('rect')
      .attr('width', legendRectSize)
      .attr('height', legendRectSize-legendSpacing)
      .attr('x', legendRectSize + legendSpacing)
      .attr('y', legendRectSize - legendSpacing + 20*i)
      .style('fill', colors[i])
      .style('stroke', colors[i]);

      legend.append('text')
      .attr('class', 'countryLegendText')
      .attr('x', legendRectSize + legendSpacing*7)
      .attr('y', legendRectSize + legendSpacing*2 + 20*i)
      .text(colorNames[i]);
      }

      });

   }

    // Loads the data

    // IHDI
    // Ranking, Country, 2014 Ranking, Compared to HDI ranking
    function loadIHDI(){
      d3.csv("IHDI.csv", function(data){
        for (var i= 0; i < data.length; i ++){
          ihdi[data[i].Country] = data[i];
        }
        loadHDI();
      });
    }

    // HDI
    function loadHDI(){
      d3.csv("HDI.csv", function(data){
        for (var i = 0; i < data.length; i ++){
          hdi[data[i].Country] = data[i];
        }

        d3.tsv("hdi2.csv", function(data2){
          for (var i = 0; i < data2.length; i ++){
            hdi2[data2[i].Countryn] = data2[i];
          }
        });
        loadGII();
      });

    }

    // GII
    function loadGII(){
      d3.csv("GII.csv", function(data){
        for (var i = 0; i <data.length; i ++){
          gii[data[i].Country] = data[i];
        }
        loadGDP();
      });
    }

    // GDP Market Price
    function loadGDP(){
      d3.csv("GDP_per_capita.csv", function(data){
        for (var i=0; i < data.length; i ++){
          gdp[data[i].Country] = data[i];
        }
        loadInfographics();
      });
    }

    function loadInfographics(){
      loadWorld();
      loadGIIMap();
      loadGIIGraph();
      overallGDP();
    }

    //
    //
    //
    // Post-Load Actions
    // This is what happens when humans get to interact with the map
    //
    //
    //

    var savedPreviously = [];
    var showAllCountries = false;
    var clickedPreviously = [];

    function clicked(d) {
      var x, y, k;
      var countryName = idMap[d.id];
      $("#fmd_title").html(countryName);

      if (d && centered !== d) {
        centered = d;
      } else {
        centered = null;
      }

      var countryData = ihdi[countryName];
      if (countryData && countryData.Ranking) {
        $("#fmd_ranking").html("#"+countryData.Ranking +" Ranked Country in the World");
        drawCircle("#fmd_ihdi", 0, countryData["2014"], 1);
        drawHDIGraph(hdi[countryName]);
      } else {
        $("#fmd_ihdi").empty();
        $("#fmd_hdi").empty();
        $("#fmd_ranking").html("We do not have data on this country :(");
      }

      g.selectAll("path")
      .classed("active", centered && function(d) { return d === centered; });

      function determineClassName(d) {
        var countryName = idMap[d.id];
        var className = "";

        if (!ihdi[countryName]) {
          return "";
        }
        var value = ihdi[countryName]["Ranking"];

        if (value <= 48){
          className = "pressedBest";
        } else if (value > 48 && value <= 100){
          className = "pressedMidHigh";
        } else if (value > 100 && value <= 140){
          className = "pressedMidLow";
        } else if (value > 140){
          className = "pressedLow";
        }
        return className;
      }

      g.selectAll("path")
      .classed("pressedBest", function(d) { return (determineClassName(d) == "pressedBest") && clickedPreviously.indexOf(d.id)>=0; })
      .classed("pressedMidHigh", function(d) { return (determineClassName(d) == "pressedMidHigh" ) && clickedPreviously.indexOf(d.id)>=0; })
      .classed("pressedMidLow", function(d) { return determineClassName(d) == "pressedMidLow" && clickedPreviously.indexOf(d.id)>=0; })
      .classed("pressedLow", function(d) { return determineClassName(d) == "pressedLow" && clickedPreviously.indexOf(d.id)>=0; });


      clickedPreviously.push(d.id);
      savedPreviously.push(d.id);
    }

      function drawCircle(idName, start, end, total){

        $(idName).empty();

        var colors = {
          'best': '#02197D',
          'decent': '#2B4FEC',
          'bad' : '#2DA0E9',
          'worst' : '#85D9FF'
        };

        var color =
        function(){
          if (end >= 0.818){
            return colors.best;
          } else if (end >= 0.717) {
            return colors.decent;
          } else if (end >= 0.579) {
            return colors.bad;
          }else {
            return colors.worst;
          }
        }();

        var radius = 100;
        var border = 5;
        var padding = 30;

        var startPercent = start;
        var endPercent = end < 1? end*100 : end;

        var twoPi = Math.PI * 2;
        var formatPercent = d3.format(',.2f');
        var boxSize = (radius + padding) * 2;

        var count = Math.abs((endPercent - startPercent));
        var step = endPercent < startPercent ? -0.01:0.01;

        var arc = d3.svg.arc()
        .startAngle(0)
        .innerRadius(radius)
        .outerRadius(radius - border);

        var parent = d3.select(idName);

        var svg = parent.append('svg')
        .attr('width', boxSize)
        .attr('height', boxSize);

        var defs = svg.append('defs');

        var g = svg.append('g')
        .attr('transform', 'translate(' + boxSize / 2 + ',' + boxSize / 2 + ')');

        var meter = g.append('g')
        .attr('class', 'progress-meter');

        var foreground = meter.append('path')
        .attr('class', 'foreground')
        .attr('fill', color)
        .attr('fill-opacity', 1)
        .attr('stroke', color)
        .attr('stroke-width', 5)
        .attr('stroke-opacity', 1);

        var front = meter.append('path')
        .attr('class', 'foreground')
        .attr('fill', color)
        .attr('fill-opacity', 0.85);

        var numberText = meter.append('text')
        .attr('fill', 'black')
        .attr('text-anchor', 'middle')
        .attr('dy', '.35em');

        $("#fmd_ihdi").append('2014 IHDI Value').attr("class", "graphLabel");

        function updateProgress(progress) {
          foreground.attr('d', arc.endAngle(twoPi * progress/total));
          front.attr('d', arc.endAngle(twoPi * progress/total));
          numberText.text(formatPercent(progress));
        }

        var progress = startPercent;

        (function loops() {
          updateProgress(progress);

          if (count > 0) {
            count--;
            progress += step;
            setTimeout(loops, 5);
          }
        })();
      }

      function drawHDIGraph(countryData){

        $("#fmd_hdi").empty();

        var hdiWidth = 250;
        var hdiHeight = 270;
        var hdiPadding = 60;

        var lineData = [];
        var tempData = ["1990", "2010", "2011", "2012", "2013", "2014"];

        for (var i = 0; i < tempData.length; i ++) {
          lineData.push({
            "x":tempData[i],
            "y":countryData[tempData[i]]
          });
        }

        var svghdi = d3.select("#fmd_hdi").append("svg")
        .attr("width", hdiWidth)
        .attr("height",hdiHeight);
        var extents = d3.extent(lineData.map(function(d){return d.y;}));
        extents[0] -= 0.1;
        extents[1] = 1;

        var xScale = d3.scale.linear()
        .domain([1990,2014]).range([hdiPadding, hdiWidth-hdiPadding]);
        var yScale = d3.scale.linear()
        .domain(extents).range([hdiHeight-hdiPadding, hdiPadding]);

        var xAxis = d3.svg.axis().scale(xScale).orient("bottom").ticks(10)
        .tickFormat(d3.format(".0f"));
        var yAxis = d3.svg.axis().scale(yScale).orient("left").ticks(10);

        svghdi.append("g").attr("class", "axis")
        .attr("transform", "translate("+hdiPadding+",0)")
        .call(yAxis);

        svghdi.append("g").attr("class", "axis")
        .attr("transform", "translate(0," + (hdiHeight - hdiPadding) + ")")
        .call(xAxis)
        .selectAll("text")
        .style("text-anchor", "end")
        .attr("dx", "-.8em")
        .attr("dy", ".15em")
        .attr("transform", "rotate(-90)");

        svghdi.append("text").attr("x", hdiWidth/5).attr("y", hdiPadding*2/3)
        .text("HDI Score over 5 years").attr("class", "graphLabel");


        svghdi.append("text").text("Years")
        .attr("class", "graphLabelSmall")
        .attr("x", 65)
        .attr("y", hdiHeight-15);

        svghdi.append("text").text("HDI Score")
        .attr("class", "graphLabelSmall")
        .attr("x", 75)
        .attr("y", -10)
        .attr("transform", "rotate(90)");



        var lineFunction = d3.svg.line()
        .x(function(d) {return xScale(d.x);})
        .y(function(d) {return yScale(d.y);})
        svghdi.append("path").attr("d", lineFunction(lineData))
        .attr("class", "hdiLine");
     }

     function loadGIIMap(){
      var width = 900,
      height = 600,
      centered;

      var projection = d3.geo.mercator()
      .scale(150)
      .translate([width/2, height/2]);

      var path = d3.geo.path()
      .projection(projection);

      var svg = d3.select("#middlemap").append("svg")
      .attr("width", width)
      .attr("height", height);

      svg.append("rect")
      .attr("class", "background")
      .attr("width", width)
      .attr("height", height)

      var g = svg.append("g");
      d3.json("world.json", function(error, world) {
        if (error) throw error;

        g.append("g")
        .attr("id", "countriesGII")
        .selectAll("path")
        .data(topojson.feature(world, world.objects.countries).features)
        .enter().append("path")
        .attr("d", path)
        .on("click", giiClick)
        .on("mouseover", function(d) {
            var tempCountryName = idMap[d.id];

            var tempString = ihdi[tempCountryName] ?
                ("World Ranking: " + ihdi[tempCountryName]["Ranking"] + " <br>"
                + "IHDI Score: " + ihdi[tempCountryName]["2014"] + " <br>") : "No Data Present";
            tooltip .style("opacity", .7);
                tooltip.html(tempCountryName + " <br><br>" + tempString)
                .style("left", (d3.event.pageX) + "px")
                .style("top", (d3.event.pageY - 85) + "px");
            })

        .on("mouseout", function(){
                tooltip .style("opacity", 0);
              })

        .attr("class", function(d){
          if (gii[idMap[d.id]]){
            var val = Number(gii[idMap[d.id]]["2014"]);
            if (val && val != NaN){
              if (val < 0.05) {
                return "bestGII";
              } else if (val < 0.1) {
                return "greatGII";
              } else if (val < 0.3) {
                return "averageGII";
              } else if (val < 0.4) {
                return "badGII";
              } else {
                return "worstGII";
              }
            }
          }
        return "none";});



        g.append("path")
        .datum(topojson.mesh(world, world.objects.countries, function(a, b) { return a !== b; }))
        .attr("id", "country-borders")
        .attr("d", path);

      });

      var legendRectSize = 18;
      var legendSpacing = 4;
      var colors = ["#AAAAAA", "#ffb3b3", "#ff6666", "#ff0000", "#990000", "#330000"].reverse();
      var colorNames = ["No Data", "Worst", "Bad", "Average", "Great", "Best"].reverse();

      var legend = svg.selectAll('.legend')
      .data(colors)
      .enter()
      .append('g')
      .attr('class', 'legend')
      .attr('transform', 'translate(50,400)');


      for (var i = 0; i < colors.length; i ++){
      legend.append('rect')
      .attr('width', legendRectSize)
      .attr('height', legendRectSize-legendSpacing)
      .attr('x', legendRectSize + legendSpacing)
      .attr('y', legendRectSize - legendSpacing + 20*i)
      .style('fill', colors[i])
      .style('stroke', colors[i]);

      legend.append('text')
      .attr('class', 'countryLegendText')
      .attr('x', legendRectSize + legendSpacing*7)
      .attr('y', legendRectSize + legendSpacing*2 + 20*i)
      .text(colorNames[i]);
      }

     }

     var mainCountries = ["Switzerland", "Germany", "Netherlands", "Japan", "Algeria"];

     function loadGIIGraph(name){
       if (name && gii[name] && mainCountries.indexOf(name) == -1) {
         mainCountries.push(name);
       }
       var values = mainCountries.map(function(d){
         return gii[d];
       });

       var width = 500,
       height = 900,
       padding = 50;

       var x = d3.scale.linear()
       .domain([0, d3.max(values.map(function(d){return 0.1 + Number(d["2014"]);}))])
       .range([0, 420]);

       d3.select("#middlegraph")
       .selectAll("div")
       .data(values)
       .enter().append("div")
       .attr("class", function(d){
         var tempVar = d["2014"];
         if (tempVar<0.05){
         return "bestGII";
         } else if (tempVar < 0.1){
         return "greatGII";
         } else if (tempVar < 0.3){
         return "averageGII";
         } else if (tempVar < 0.4){
         return "badGII";
         } else{
         return "worstGII";
         }
       })
       .transition()
       .duration(1000)
       .ease("quad")
       .attr("width", x)
       .style("width", function(d) { return x(Number(d["2014"])+0.1) + "px"; })
       .text(function(d) { return d["Country"] + ":" + d["2014"]; }).style("color","white");
     }

     function giiClick(d){
        d3.selectAll("#middlemap")
        .selectAll("path").classed("active",
          function(x){
              return d.id==x.id;
          });

       loadGIIGraph(idMap[d.id]);
     }

     // GDP Drawing
    function overallGDP(){
      var gdpX;
      var gdpY;
      var gdpWidth = 700,
      gdpHeight = 400,
      gdpPadding = 50;

      var parseDate = d3.time.format("%Y%m%d").parse;

      var gdpsvg;

      var yearsGDP = ["1975", "1980", "1985","1990", "1995", "2000", "2010", "2011", "2012", "2013", "2014"];

      $(function() {
        $("#slider-range").slider({
        min: 0,
        max: yearsGDP.length - 1,
        value: 0,
        slide: function(event, ui) {
          $("#amount").html(yearsGDP[ui.value]);
          d3.select("#gdpgraph").select("svg").remove();
          drawGDP(yearsGDP[ui.value]);
        }
        });
      })



      drawGDP("1975");

      function drawGDP(year){
        gdpsvg = d3.select("#gdpgraph").append("svg")
        .attr("width", gdpWidth)
        .attr("height", gdpHeight)
        .append("g");


        var yearData = [];

        // Gets all the country datas
        for (var key in idMap) {
          var countryName = idMap[key];

          var noGDPValue = (!gdp[countryName] || !gdp[countryName][year]);
          var noHDIValue =
          (!hdi[countryName] || !hdi[countryName][year] ||
          isNaN(Number(hdi[countryName][year]))) &&
          (!hdi2[countryName] || !hdi2[countryName][year] ||
          isNaN(Number(hdi2[countryName][year])))

          // For bad countries not in our data set
          if (noGDPValue || noHDIValue) {
            continue;
          }

          yearData.push({
            "name":countryName,
            "gdp": Number(gdp[countryName][year]),
            "hdi": (isNaN(Number(hdi[countryName][year]))? Number(hdi2[countryName][year]) :
            Number(hdi[countryName][year]))

          });
        }
        gdpX = d3.scale.log()
        .domain(d3.extent(yearData, function(d){return Number(d["gdp"]);}))
        .range([gdpPadding, gdpWidth-gdpPadding]);

        gdpY = d3.scale.linear()
        .domain([0.1,1])
        .range([gdpHeight-gdpPadding, gdpPadding]);

        var xAxis = d3.svg.axis()
        .scale(gdpX)
        .orient("bottom")
        .ticks(20, d3.format("s"));

        var yAxis = d3.svg.axis()
        .scale(gdpY)
        .orient("left");


        gdpsvg.append("g")
        .attr("class", "y axis")
        .attr("transform", "translate(" + gdpPadding+ ",0)")
        .call(yAxis)
        .append("text")
        .attr("transform", "rotate(-90)")
        .attr("y", 6)
        .attr("dy", ".71em")
        .style("text-anchor", "end");

        gdpsvg.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + Number(gdpHeight-gdpPadding)+ ")")
        .call(xAxis)
        .selectAll("text")
        .attr("y", 0)
        .attr("x", 9)
        .attr("dy", ".35em")
        .attr("transform", "rotate(90)")
        .style("text-anchor", "start");

        gdpsvg.append("text").attr("x", gdpWidth/3 - gdpPadding).attr("y", gdpHeight- (1.0/4)*gdpPadding).text("Log of GDP per Capita in USD").attr("class", "label");


        gdpsvg.append("text").attr("x", 10).attr("y", gdpHeight/2)
        .text("HDI").attr("class", "label")
        .attr("alignment-baseline", "central");

       gdpsvg .selectAll(".dot")
        .data(yearData)
        .enter().append("circle")
        .attr("class", "dot")
        .attr("r", 3)
        .attr("cx", function(d){return gdpX(d["gdp"]);})
        .attr("cy", function(d){
        return gdpY(d["hdi"]);})
        .style("fill", "#000");
      }
      }



    </script>
  <script>
    $(document).on('click', '.toggle-button', function() {
        if (!showAllCountries) {
          showAllCountries = true;
          savedPreviously = clickedPreviously;
          clickedPreviously = Object.keys(idMap).map(function(d){return Number(d);});
          var tempCentered = centered;
          if (!centered) {
            centered = null;
            clicked({"id":840});
          } else {
            centered = null;
            clicked(tempCentered);
          }
        } else {
          showAllCountries = false;
          clickedPreviously = savedPreviously;

          var tempCentered = centered;
          if (!centered) {
            clicked({"id":840});
          } else {
            centered = null;
            clicked(tempCentered);
          }
        }
          $(this).toggleClass('toggle-button-selected');
        });
  </script>



  <script>
//bubble chart
 var tooltip = d3.select("body").append("div").attr("class", "tooltip").style("opacity", 0);

function drawbubble(year){

  var diameter = 800, //max size of the bubbles
  color    = d3.scale.category20b(); //color category

  var bubble = d3.layout.pack()
    .sort(null)
    .size([diameter, diameter])
    .padding(1.5);

  var svg = d3.select("#bubblegraph")
    .append("svg")
    .attr("width", diameter)
    .attr("height", diameter)
    .attr("class", "bubble");
  d3.csv("gdp_market.csv", function(error, data){
    //convert numerical values from strings to numbers
    data = data.map(function(d){ d.value = +d[year]; return d; });

    //bubbles needs very specific format, convert data to this.
    var nodes = bubble.nodes({children:data}).filter(function(d) { return !d.children; });

    //setup the chart
    var bubbles = svg.append("g")
        .attr("transform", "translate(0,0)")
        .selectAll(".bubble")
        .data(nodes)
        .enter();

    //create the bubbles
    bubbles.append("circle")
        .attr("r", function(d){ return d.r; })
        .attr("cx", function(d){ return d.x; })
        .attr("cy", function(d){ return d.y; })
        .style("fill", function(d) { return color(d.value); })

        .on("mouseover", function(d) {
            var tempCountryName = d["Country"];

            var tempString = d.value/1000000000 + "Billion Dollars";
            tooltip .style("opacity", .7);
                tooltip.html(tempCountryName + " <br><br>" + tempString)
                .style("left", (d3.event.pageX) + "px")
                .style("top", (d3.event.pageY - 85) + "px");
            }) .on("mouseout", function(){
                tooltip .style("opacity", 0);
              });

    // format the text for each bubble
    bubbles.append("text")
        .attr("x", function(d){ return d.x; })
        .attr("y", function(d){ return d.y + 5; })
        .attr("text-anchor", "middle")
        .text(function(d){  return d.r>25 ? d["Country"] : ""; })
        .style({
            "fill":"white",
            "font-size": "15px"
        });
  })
};
var yearsGDP = ["1975", "1980", "1985","1990", "1995", "2000", "2010", "2011", "2012", "2013", "2014"];

      $(function() {
        $("#bubble-slider-range").slider({
        min: 0,
        max: yearsGDP.length - 1,
        value: 0,
        slide: function(event, ui) {
          $("#bubbleamount").html(yearsGDP[ui.value]);
          d3.select("#bubblegraph").select("svg").remove();
          drawbubble(yearsGDP[ui.value]);
        }
        });
      })

drawbubble(1975);

</script>
  </body>
</html>
