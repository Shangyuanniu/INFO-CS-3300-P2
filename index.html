<html>
  <style>

    .background {
      fill: none;
      pointer-events: all;
    }

    #countries{
      fill: #aaa;
    }


    #country-borders {
      fill: none;
      stroke: #fff;
      stroke-width: 1.5px;
      stroke-linejoin: round;
      stroke-linecap: round;
      pointer-events: none;
    }
   .label {
      font-size:10pt;
    }
    .axis path {fill: none; stroke: black;}
    .axis line {stroke:black;}
    .axis text {font-size: 8pt;}
    table, th, td {
      border: 1px solid black;
    }

    .p8line {
      fill:none;
      stroke: black;
      stroke-width:5;
    }
  </style>

  <head>
    <title>
      INFO 3300 Project 2
    </title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <script src = "http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <script src = "http://d3js.org/topojson.v1.min.js" charset="utf-8"></script>
    <script src = "http://d3js.org/queue.v1.min.js" charset="utf-8"></script>
    <link rel="stylesheet" type="text/css" href="custom.css">
    <link rel="stylesheet" type="text/css" href="button.css">
  </head>
  <body>
    <div class="title">
      <h1>INFO 3300 Project 2</h1>
      <h4>By: Net IDs</h4>
    </div>
    <div id="top">
      <h2> World by Inequality Adjusted Human Development Index<h2>
      <div id="firstmap"></div>
      <div id="firstmapdata">
        <!-- FMD means FirstMapData -->
        <div id="fmd_title">
          Click on many countries!
        </div>

        <div id= "fmd_ranking"></div>
        <div id="fmd_info">
          <div id="fmd_ihdi">
          </div>
          <div id="fmd_hdi">
          </div>
        </div>
        <div id="fmd_button">
          <div class="toggle-button">
            <button></button>
          </div>
          <div class="toggle-button-text">Show All On Map</div>
        </div>

      </div>
    </div>

    <div id = "middle">
      <h2> World by Gender Inequality Index</h2>
      <div id = "middlemap"></div>
      <div id = "middlegraph">
        <h3> Gender Inequality Scores</h3>
        <p> Smaller means less inequality.</p>
      </div>
    </div>
    <script>

    var width = 740,
    height = 550,
    centered;

    var q = queue(4);

    var projection = d3.geo.mercator()
    .scale(125)
    .translate([width/2, height/2])
    ;

    var path = d3.geo.path()
    .projection(projection);

    var svg = d3.select("#firstmap").append("svg")
    .attr("width", width)
    .attr("height", height);

    svg.append("rect")
    .attr("class", "background")
    .attr("width", width)
    .attr("height", height)
    .on("click", clicked);

    var tooltip = d3.select("body").append("div").attr("class", "tooltip").style("opacity", 0);

    var g = svg.append("g");
    var idMap = {};
    var ihdi = {};
    var hdi = {};
    var gii = {};

    //
    //
    //
    // Pre-Load Actions: This is what happens before humans can interact
    // with the page
    //
    //
    //

    // Reading ID -> Countries
    function readCountryNames() {
      d3.tsv("names.csv", function(data){
        for(var i = 0;i < data.length; i++) {
          idMap[data[i].id] = data[i].name;
        }
        loadIHDI();
      });
    }

    readCountryNames();

    // Loads the World Map
    function loadWorld() {
      return d3.json("world.json", function(error, world) {
        if (error) throw error;

        g.append("g")
        .attr("id", "countries")
        .selectAll("path")
        .data(topojson.feature(world, world.objects.countries).features)
        .enter().append("path")
        .attr("d", path)
        .on("click", clicked)
        .on("mouseover", function(d) {
            var tempCountryName = idMap[d.id];

            var tempString = ihdi[tempCountryName] ?
                ("World Ranking: " + ihdi[tempCountryName]["Ranking"] + " <br>"
                + "IHDI Score: " + ihdi[tempCountryName]["2014"] + " <br>") : "No Data Present";
            tooltip .style("opacity", .7);
                tooltip.html(tempCountryName + " <br><br>" + tempString)
                .style("left", (d3.event.pageX) + "px")
                .style("top", (d3.event.pageY - 85) + "px");
            });
        g.append("path")
        .datum(topojson.mesh(world, world.objects.countries, function(a, b) { return a !== b; }))
        .attr("id", "country-borders")
        .attr("d", path);

      var legendRectSize = 14;
      var legendSpacing = 4;
      var colors = ["#a6a6a6", "#80ff80", "#00dd00", "#008000", "#003000"].reverse();
      var colorNames = ["No Data", "Worst", "Bad", "Decent", "Best"].reverse();

      var legend = svg.selectAll('.legend')
      .data(colors)
      .enter()
      .append('g')
      .attr('class', 'legend')
      .attr('transform', 'translate(50,400)');

      for (var i = 0; i < colors.length; i ++){
      legend.append('rect')
      .attr('width', legendRectSize)
      .attr('height', legendRectSize-legendSpacing)
      .attr('x', legendRectSize + legendSpacing)
      .attr('y', legendRectSize - legendSpacing + 20*i)
      .style('fill', colors[i])
      .style('stroke', colors[i]);

      legend.append('text')
      .attr('class', 'countryLegendText')
      .attr('x', legendRectSize + legendSpacing*7)
      .attr('y', legendRectSize + legendSpacing*2 + 20*i)
      .text(colorNames[i]);
      }

      });

   }

    // Loads the data

    // IHDI
    // Ranking, Country, 2014 Ranking, Compared to HDI ranking
    function loadIHDI(){
      d3.csv("IHDI.csv", function(data){
        for (var i= 0; i < data.length; i ++){
          ihdi[data[i].Country] = data[i];
        }
        loadHDI();
      });
    }

    // HDI
    function loadHDI(){
      d3.csv("HDI.csv", function(data){
        for (var i = 0; i < data.length; i ++){
          hdi[data[i].Country] = data[i];
        }
        loadGII();
      });
    }

    // GII
    function loadGII(){
      d3.csv("GII.csv", function(data){
        for (var i = 0; i <data.length; i ++){
          gii[data[i].Country] = data[i];
        }
        loadInfographics();
      });
    }

    function loadInfographics(){
      loadWorld();
      loadGIIMap();
      loadGIIGraph();
    }

    //
    //
    //
    // Post-Load Actions
    // This is what happens when humans get to interact with the map
    //
    //
    //

    var savedPreviously = [];
    var showAllCountries = false;
    var clickedPreviously = [];

    function clicked(d) {
      var x, y, k;
      var countryName = idMap[d.id];
      $("#fmd_title").html(countryName);

      if (d && centered !== d) {
        centered = d;
      } else {
        centered = null;
      }

      var countryData = ihdi[countryName];
      if (countryData && countryData.Ranking) {
        $("#fmd_ranking").html("#"+countryData.Ranking +" Ranked Country in the World");
        drawCircle("#fmd_ihdi", 0, countryData["2014"], 1);
        drawHDIGraph(hdi[countryName]);
      } else {
        $("#fmd_ihdi").empty();
        $("#fmd_hdi").empty();
        $("#fmd_ranking").html("We do not have data on this country :(");
      }

      g.selectAll("path")
      .classed("active", centered && function(d) { return d === centered; });

      function determineClassName(d) {
        var countryName = idMap[d.id];
        var className = "";

        if (!ihdi[countryName]) {
          return "";
        }
        var value = ihdi[countryName]["Ranking"];

        if (value <= 25){
          className = "pressedBest";
        } else if (value > 25 && value <= 50){
          className = "pressedMidHigh";
        } else if (value > 50 && value <= 75){
          className = "pressedMidLow";
        } else if (value > 75){
          className = "pressedLow";
        }
        return className;
      }

      g.selectAll("path")
      .classed("pressedBest", function(d) { return (determineClassName(d) == "pressedBest") && clickedPreviously.indexOf(d.id)>=0; })
      .classed("pressedMidHigh", function(d) { return (determineClassName(d) == "pressedMidHigh" ) && clickedPreviously.indexOf(d.id)>=0; })
      .classed("pressedMidLow", function(d) { return determineClassName(d) == "pressedMidLow" && clickedPreviously.indexOf(d.id)>=0; })
      .classed("pressedLow", function(d) { return determineClassName(d) == "pressedLow" && clickedPreviously.indexOf(d.id)>=0; });


      clickedPreviously.push(d.id);
      savedPreviously.push(d.id);
    }

      function drawCircle(idName, start, end, total){

        $(idName).empty();

        var colors = {
          'yellow': '#ffff66',
          'green': '#00ff00',
          'red' : '#FF0000'
        };

        var color =
        function(){
          if (end > 0.9){
            return colors.green;
          } else if (end > 0.75) {
            return colors.yellow;
          } else {
            return colors.red;
          }
        }();

        var radius = 100;
        var border = 5;
        var padding = 30;

        var startPercent = start;
        var endPercent = end < 1? end*100 : end;

        var twoPi = Math.PI * 2;
        var formatPercent = d3.format(',.2f');
        var boxSize = (radius + padding) * 2;

        var count = Math.abs((endPercent - startPercent));
        var step = endPercent < startPercent ? -0.01:0.01;

        var arc = d3.svg.arc()
        .startAngle(0)
        .innerRadius(radius)
        .outerRadius(radius - border);

        var parent = d3.select(idName);

        var svg = parent.append('svg')
        .attr('width', boxSize)
        .attr('height', boxSize);

        var defs = svg.append('defs');

        var g = svg.append('g')
        .attr('transform', 'translate(' + boxSize / 2 + ',' + boxSize / 2 + ')');

        var meter = g.append('g')
        .attr('class', 'progress-meter');

        var foreground = meter.append('path')
        .attr('class', 'foreground')
        .attr('fill', color)
        .attr('fill-opacity', 1)
        .attr('stroke', color)
        .attr('stroke-width', 5)
        .attr('stroke-opacity', 1);

        var front = meter.append('path')
        .attr('class', 'foreground')
        .attr('fill', color)
        .attr('fill-opacity', 0.85);

        var numberText = meter.append('text')
        .attr('fill', 'black')
        .attr('text-anchor', 'middle')
        .attr('dy', '.35em');

        $("#fmd_ihdi").append('2014 IHDI Value').attr("class", "graphLabel");

        function updateProgress(progress) {
          foreground.attr('d', arc.endAngle(twoPi * progress/total));
          front.attr('d', arc.endAngle(twoPi * progress/total));
          numberText.text(formatPercent(progress));
        }

        var progress = startPercent;

        (function loops() {
          updateProgress(progress);

          if (count > 0) {
            count--;
            progress += step;
            setTimeout(loops, 5);
          }
        })();
      }

      function drawHDIGraph(countryData){

        $("#fmd_hdi").empty();

        var hdiWidth = 250;
        var hdiHeight = 270;
        var hdiPadding = 60;

        var lineData = [];
        var tempData = ["1990", "2010", "2011", "2012", "2013", "2014"];

        for (var i = 0; i < tempData.length; i ++) {
          lineData.push({
            "x":tempData[i],
            "y":countryData[tempData[i]]
          });
        }

        var svghdi = d3.select("#fmd_hdi").append("svg")
        .attr("width", hdiWidth)
        .attr("height",hdiHeight);
        var extents = d3.extent(lineData.map(function(d){return d.y;}));
        extents[0] -= 0.1;
        extents[1] = 1;

        var xScale = d3.scale.linear()
        .domain([1990,2014]).range([hdiPadding, hdiWidth-hdiPadding]);
        var yScale = d3.scale.linear()
        .domain(extents).range([hdiHeight-hdiPadding, hdiPadding]);

        var xAxis = d3.svg.axis().scale(xScale).orient("bottom").ticks(10)
        .tickFormat(d3.format(".0f"));
        var yAxis = d3.svg.axis().scale(yScale).orient("left").ticks(10);

        svghdi.append("g").attr("class", "axis")
        .attr("transform", "translate("+hdiPadding+",0)")
        .call(yAxis);

        svghdi.append("g").attr("class", "axis")
        .attr("transform", "translate(0," + (hdiHeight - hdiPadding) + ")")
        .call(xAxis)
        .selectAll("text")
        .style("text-anchor", "end")
        .attr("dx", "-.8em")
        .attr("dy", ".15em")
        .attr("transform", "rotate(-90)");

        svghdi.append("text").attr("x", hdiWidth/5).attr("y", hdiPadding*2/3)
        .text("HDI Score over 5 years").attr("class", "graphLabel");


        svghdi.append("text").text("Years")
        .attr("class", "graphLabelSmall")
        .attr("x", 65)
        .attr("y", hdiHeight-15);

        svghdi.append("text").text("HDI Score")
        .attr("class", "graphLabelSmall")
        .attr("x", 75)
        .attr("y", -10)
        .attr("transform", "rotate(90)");



        var lineFunction = d3.svg.line()
        .x(function(d) {return xScale(d.x);})
        .y(function(d) {return yScale(d.y);})
        svghdi.append("path").attr("d", lineFunction(lineData))
        .attr("class", "hdiLine");
     }

     function loadGIIMap(){
      var width = 900,
      height = 600,
      centered;

      var projection = d3.geo.mercator()
      .scale(150)
      .translate([width/2, height/2]);

      var path = d3.geo.path()
      .projection(projection);

      var svg = d3.select("#middlemap").append("svg")
      .attr("width", width)
      .attr("height", height);

      svg.append("rect")
      .attr("class", "background")
      .attr("width", width)
      .attr("height", height)

      var g = svg.append("g");
      d3.json("world.json", function(error, world) {
        if (error) throw error;

        g.append("g")
        .attr("id", "countriesGII")
        .selectAll("path")
        .data(topojson.feature(world, world.objects.countries).features)
        .enter().append("path")
        .attr("d", path)
        .on("click", giiClick)
        .on("mouseover", function(d) {
            var tempCountryName = idMap[d.id];

            var tempString = ihdi[tempCountryName] ?
                ("World Ranking: " + ihdi[tempCountryName]["Ranking"] + " <br>"
                + "IHDI Score: " + ihdi[tempCountryName]["2014"] + " <br>") : "No Data Present";
            tooltip .style("opacity", .7);
                tooltip.html(tempCountryName + " <br><br>" + tempString)
                .style("left", (d3.event.pageX) + "px")
                .style("top", (d3.event.pageY - 85) + "px");
            })
        .attr("class", function(d){
          if (gii[idMap[d.id]]){
            var val = Number(gii[idMap[d.id]]["2014"]);
            if (val && val != NaN){
              if (val < 0.05) {
                return "bestGII";
              } else if (val < 0.1) {
                return "greatGII";
              } else if (val < 0.3) {
                return "averageGII";
              } else if (val < 0.4) {
                return "badGII";
              } else {
                return "worstGII";
              }
            }
          }
        return "none";});



        g.append("path")
        .datum(topojson.mesh(world, world.objects.countries, function(a, b) { return a !== b; }))
        .attr("id", "country-borders")
        .attr("d", path);

      });

      var legendRectSize = 18;
      var legendSpacing = 4;
      var colors = ["#FF0000", "#FF9000", "#D0FF00", "#80FF00", "#00FF00", "#000000", "#0066ff"];
      var colorNames = ["Worst", "Bad", "Average", "Great", "Best", "No Data", "Selected"];

      var legend = svg.selectAll('.legend')
      .data(colors)
      .enter()
      .append('g')
      .attr('class', 'legend')
      .attr('transform', 'translate(50,400)');


      for (var i = 0; i < colors.length; i ++){
      legend.append('rect')
      .attr('width', legendRectSize)
      .attr('height', legendRectSize-legendSpacing)
      .attr('x', legendRectSize + legendSpacing)
      .attr('y', legendRectSize - legendSpacing + 20*i)
      .style('fill', colors[i])
      .style('stroke', colors[i]);

      legend.append('text')
      .attr('class', 'countryLegendText')
      .attr('x', legendRectSize + legendSpacing*7)
      .attr('y', legendRectSize + legendSpacing*2 + 20*i)
      .text(colorNames[i]);
      }

     }

     var mainCountries = ["Switzerland", "Germany", "Netherlands", "Japan", "Algeria"];

     function loadGIIGraph(name){
       if (name && gii[name] && mainCountries.indexOf(name) == -1) {
         mainCountries.push(name);
       }
       var values = mainCountries.map(function(d){
         return gii[d];
       });

       var width = 500,
       height = 900,
       padding = 50;

       var x = d3.scale.linear()
       .domain([0, d3.max(values.map(function(d){return 0.1 + Number(d["2014"]);}))])
       .range([0, 420]);

       d3.select("#middlegraph")
       .selectAll("div")
       .data(values)
       .enter().append("div")
       .attr("class", function(d){
         var tempVar = d["2014"];
         if (tempVar<0.05){
         return "bestGII";
         } else if (tempVar < 0.1){
         return "greatGII";
         } else if (tempVar < 0.3){
         return "averageGII";
         } else if (tempVar < 0.4){
         return "badGII";
         } else{
         return "worstGII";
         }
       })
       .transition()
       .duration(300)
       .style("width", function(d) { return x(Number(d["2014"])+0.1) + "px"; })
       .text(function(d) { return d["Country"] + ":" + d["2014"]; });
     }

     function giiClick(d){
        d3.selectAll("#middlemap")
        .selectAll("path").classed("active",
          function(x){
              return d.id==x.id;
          });

       loadGIIGraph(idMap[d.id]);
     }

    </script>

  <script>
    $(document).on('click', '.toggle-button', function() {
        if (!showAllCountries) {
          showAllCountries = true;
          savedPreviously = clickedPreviously;
          clickedPreviously = Object.keys(idMap).map(function(d){return Number(d);});
          var tempCentered = centered;
          if (!centered) {
            centered = null;
            clicked({"id":840});
          } else {
            centered = null;
            clicked(tempCentered);
          }
        } else {
          showAllCountries = false;
          clickedPreviously = savedPreviously;

          var tempCentered = centered;
          if (!centered) {
            clicked({"id":840});
          } else {
            centered = null;
            clicked(tempCentered);
          }
        }
          $(this).toggleClass('toggle-button-selected');
        });
  </script>
  </body>
</html>
