<html>
  <style>

    .background {
      fill: none;
      pointer-events: all;
    }

    #countries{
      fill: #aaa;
    }


    #country-borders {
      fill: none;
      stroke: #fff;
      stroke-width: 1.5px;
      stroke-linejoin: round;
      stroke-linecap: round;
      pointer-events: none;
    }
   .label {
      font-size:10pt;
    }
    .axis path {fill: none; stroke: black;}
    .axis line {stroke:black;}
    .axis text {font-size: 8pt;}
    table, th, td {
      border: 1px solid black;
    }

    .p8line {
      fill:none;
      stroke: black;
      stroke-width:5;
    }
  </style>

  <head>
    <title>
      INFO 3300 Project 2
    </title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <script src = "http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <script src = "http://d3js.org/topojson.v1.min.js" charset="utf-8"></script>
    <link rel="stylesheet" type="text/css" href="custom.css">
    <link rel="stylesheet" type="text/css" href="button.css">
  </head>
  <body>
    <div class="title">
      <h1>INFO 3300 Project 2</h1>
      <h4>By: Net IDs</h4>
    </div>
    <div id="top">
      <h2> World by Inequality Adjusted Human Development Index<h2>
      <div id="firstmap"></div>
      <div id="firstmapdata">
        <!-- FMD means FirstMapData -->
        <div id="fmd_title">
          Click on many countries!
        </div>

        <div id= "fmd_ranking"></div>
        <div id="fmd_info">
          <div id="fmd_ihdi">
          </div>
          <div id="fmd_hdi">
          </div>
        </div>
        <div id="fmd_button">
          <div class="toggle-button">
            <button></button>
          </div>
          <div class="toggle-button-text">Show All</div>
        </div>

      </div>
    </div>

    <div id = "middle">
      <h2> World by Gender Inequality Index</h2>
      <div id = "middlemap"></div>
      <div id = "middlegraph">hello</div>
    </div>
    <script>

    var width = 740,
    height = 550,
    centered;

    var projection = d3.geo.mercator()
    .scale(125)
    .translate([width/2, height/2])
    ;

    var path = d3.geo.path()
    .projection(projection);

    var svg = d3.select("#firstmap").append("svg")
    .attr("width", width)
    .attr("height", height);

    svg.append("rect")
    .attr("class", "background")
    .attr("width", width)
    .attr("height", height)
    .on("click", clicked);

    var g = svg.append("g");
    var idMap = {};
    var ihdi = {};
    var hdi = {};
    var gii = {};

    //
    //
    //
    // Pre-Load Actions: This is what happens before humans can interact
    // with the page
    //
    //
    //

    // Reading ID -> Countries
    function readCountryNames(idMap) {
      d3.tsv("names.csv", function(data){
        for(var i = 0;i < data.length; i++) {
          idMap[data[i].id] = data[i].name;
        }
        return idMap;
      });
    }

    // Loads the World Map
    function loadWorld() {
      d3.json("world.json", function(error, world) {
        if (error) throw error;

        g.append("g")
        .attr("id", "countries")
        .selectAll("path")
        .data(topojson.feature(world, world.objects.countries).features)
        .enter().append("path")
        .attr("d", path)
        .on("click", clicked);

        g.append("path")
        .datum(topojson.mesh(world, world.objects.countries, function(a, b) { return a !== b; }))
        .attr("id", "country-borders")
        .attr("d", path);
      });


      var legendRectSize = 14;
      var legendSpacing = 4;
      var colors = ["#80ff80", "#00dd00", "#008000", "#003000"].reverse();
      var colorNames = ["Worst", "Bad", "Decent", "Best"].reverse();

      var legend = svg.selectAll('.legend')
      .data(colors)
      .enter()
      .append('g')
      .attr('class', 'legend')
      .attr('transform', 'translate(50,400)');


      for (var i = 0; i < colors.length; i ++){
      legend.append('rect')
      .attr('width', legendRectSize)
      .attr('height', legendRectSize-legendSpacing)
      .attr('x', legendRectSize + legendSpacing)
      .attr('y', legendRectSize - legendSpacing + 20*i)
      .style('fill', colors[i])
      .style('stroke', colors[i]);

      legend.append('text')
      .attr('class', 'countryLegendText')
      .attr('x', legendRectSize + legendSpacing*7)
      .attr('y', legendRectSize + legendSpacing*2 + 20*i)
      .text(colorNames[i]);
      }


    }

    // Loads the data

    // IHDI
    // Ranking, Country, 2014 Ranking, Compared to HDI ranking
    function loadIHDI(){
      d3.csv("IHDI.csv", function(data){
        for (var i= 0; i < data.length; i ++){
          ihdi[data[i].Country] = data[i];
        }
      });
    }

    // HDI
    function loadHDI(){
      d3.csv("HDI.csv", function(data){
        for (var i = 0; i < data.length; i ++){
          hdi[data[i].Country] = data[i];
        }
      });
    }

    // GII
    function loadGII(){
      d3.csv("GII.csv", function(data){
        for (var i = 0; i <data.length; i ++){
          gii[data[i].Country] = data[i];
        }
      });
    }

    $.when(readCountryNames(idMap)).then(loadIHDI).then(loadHDI).then(loadGII).then(loadWorld)
    .then(loadGIIMap).then(loadGIIGraph);

    //
    //
    //
    // Post-Load Actions
    // This is what happens when humans get to interact with the map
    //
    //
    //

    var savedPreviously = [];
    var showAllCountries = false;
    var clickedPreviously = [];

    function clicked(d) {
      console.log("Clicked is called");
      var x, y, k;
      var countryName = idMap[d.id];
      $("#fmd_title").html(countryName);

      if (d && centered !== d) {
        centered = d;
      } else {
        centered = null;
      }

      var countryData = ihdi[countryName];
      if (countryData && countryData.Ranking) {
        $("#fmd_ranking").html("#"+countryData.Ranking +" Ranked Country in the World");
        drawCircle("#fmd_ihdi", 0, countryData["2014"], 1);
        drawHDIGraph(hdi[countryName]);
      } else {
        $("#fmd_ihdi").empty();
        $("#fmd_hdi").empty();
        $("#fmd_ranking").html("We do not have data on this country :(");
      }

      g.selectAll("path")
      .classed("active", centered && function(d) { return d === centered; });

      function determineClassName(d) {
        var countryName = idMap[d.id];
        var className = "";

        if (!ihdi[countryName]) {
          return "";
        }
        var value = ihdi[countryName]["Ranking"];

        if (value <= 25){
          className = "pressedBest";
        } else if (value > 25 && value <= 50){
          className = "pressedMidHigh";
        } else if (value > 50 && value <= 75){
          className = "pressedMidLow";
        } else if (value > 75){
          className = "pressedLow";
        }
        return className;
      }

      g.selectAll("path")
      .classed("pressedBest", function(d) { return (determineClassName(d) == "pressedBest") && clickedPreviously.indexOf(d.id)>=0; })
      .classed("pressedMidHigh", function(d) { return (determineClassName(d) == "pressedMidHigh" ) && clickedPreviously.indexOf(d.id)>=0; })
      .classed("pressedMidLow", function(d) { return determineClassName(d) == "pressedMidLow" && clickedPreviously.indexOf(d.id)>=0; })
      .classed("pressedLow", function(d) { return determineClassName(d) == "pressedLow" && clickedPreviously.indexOf(d.id)>=0; });


      clickedPreviously.push(d.id);
      savedPreviously.push(d.id);
    }

      function drawCircle(idName, start, end, total){

        $(idName).empty();

        var colors = {
          'yellow': '#ffff66',
          'green': '#00ff00',
          'red' : '#FF0000'
        };

        var color =
        function(){
          if (end > 0.9){
            return colors.green;
          } else if (end > 0.75) {
            return colors.yellow;
          } else {
            return colors.red;
          }
        }();

        var radius = 100;
        var border = 5;
        var padding = 30;

        var startPercent = start;
        var endPercent = end < 1? end*100 : end;

        var twoPi = Math.PI * 2;
        var formatPercent = d3.format(',.2f');
        var boxSize = (radius + padding) * 2;

        var count = Math.abs((endPercent - startPercent));
        var step = endPercent < startPercent ? -0.01:0.01;

        var arc = d3.svg.arc()
        .startAngle(0)
        .innerRadius(radius)
        .outerRadius(radius - border);

        var parent = d3.select(idName);

        var svg = parent.append('svg')
        .attr('width', boxSize)
        .attr('height', boxSize);

        var defs = svg.append('defs');

        var g = svg.append('g')
        .attr('transform', 'translate(' + boxSize / 2 + ',' + boxSize / 2 + ')');

        var meter = g.append('g')
        .attr('class', 'progress-meter');

        var foreground = meter.append('path')
        .attr('class', 'foreground')
        .attr('fill', color)
        .attr('fill-opacity', 1)
        .attr('stroke', color)
        .attr('stroke-width', 5)
        .attr('stroke-opacity', 1);

        var front = meter.append('path')
        .attr('class', 'foreground')
        .attr('fill', color)
        .attr('fill-opacity', 0.85);

        var numberText = meter.append('text')
        .attr('fill', 'black')
        .attr('text-anchor', 'middle')
        .attr('dy', '.35em');

        $("#fmd_ihdi").append('2014 IHDI Value').attr("class", "graphLabel");

        function updateProgress(progress) {
          foreground.attr('d', arc.endAngle(twoPi * progress/total));
          front.attr('d', arc.endAngle(twoPi * progress/total));
          numberText.text(formatPercent(progress));
        }

        var progress = startPercent;

        (function loops() {
          updateProgress(progress);

          if (count > 0) {
            count--;
            progress += step;
            setTimeout(loops, 5);
          }
        })();
      }

      function drawHDIGraph(countryData){

        $("#fmd_hdi").empty();

        var hdiWidth = 250;
        var hdiHeight = 270;
        var hdiPadding = 60;

        var lineData = [];
        var tempData = ["1990", "2010", "2011", "2012", "2013", "2014"];

        for (var i = 0; i < tempData.length; i ++) {
          lineData.push({
            "x":tempData[i],
            "y":countryData[tempData[i]]
          });
        }

        var svghdi = d3.select("#fmd_hdi").append("svg")
        .attr("width", hdiWidth)
        .attr("height",hdiHeight);
        var extents = d3.extent(lineData.map(function(d){return d.y;}));
        extents[0] -= 0.1;
        extents[1] = 1;

        var xScale = d3.scale.linear()
        .domain([1990,2014]).range([hdiPadding, hdiWidth-hdiPadding]);
        var yScale = d3.scale.linear()
        .domain(extents).range([hdiHeight-hdiPadding, hdiPadding]);

        var xAxis = d3.svg.axis().scale(xScale).orient("bottom").ticks(10)
        .tickFormat(d3.format(".0f"));
        var yAxis = d3.svg.axis().scale(yScale).orient("left").ticks(10);

        svghdi.append("g").attr("class", "axis")
        .attr("transform", "translate("+hdiPadding+",0)")
        .call(yAxis);

        svghdi.append("g").attr("class", "axis")
        .attr("transform", "translate(0," + (hdiHeight - hdiPadding) + ")")
        .call(xAxis)
        .selectAll("text")
        .style("text-anchor", "end")
        .attr("dx", "-.8em")
        .attr("dy", ".15em")
        .attr("transform", "rotate(-90)");

        svghdi.append("text").attr("x", hdiWidth/5).attr("y", hdiPadding*2/3)
        .text("HDI Score over 5 years").attr("class", "graphLabel");


        svghdi.append("text").text("Years")
        .attr("class", "graphLabelSmall")
        .attr("x", 65)
        .attr("y", hdiHeight-15);

        svghdi.append("text").text("HDI Score")
        .attr("class", "graphLabelSmall")
        .attr("x", 75)
        .attr("y", -10)
        .attr("transform", "rotate(90)");



        var lineFunction = d3.svg.line()
        .x(function(d) {return xScale(d.x);})
        .y(function(d) {return yScale(d.y);})
        svghdi.append("path").attr("d", lineFunction(lineData))
        .attr("class", "hdiLine");




     }

     function loadGIIMap(){
      var width = 900,
      height = 600,
      centered;

      var projection = d3.geo.mercator()
      .scale(150)
      .translate([width/2, height/2])
      ;

      var path = d3.geo.path()
      .projection(projection);

      var svg = d3.select("#middlemap").append("svg")
      .attr("width", width)
      .attr("height", height);

      svg.append("rect")
      .attr("class", "background")
      .attr("width", width)
      .attr("height", height)

      var g = svg.append("g");
      d3.json("world.json", function(error, world) {
        if (error) throw error;

        g.append("g")
        .attr("id", "countriesGII")
        .selectAll("path")
        .data(topojson.feature(world, world.objects.countries).features)
        .enter().append("path")
        .attr("d", path)
        .attr("class", function(d){
          if (gii[idMap[d.id]]){
            var val = Number(gii[idMap[d.id]]["2014"]);
            if (val && val != NaN){
              if (val < 0.05) {
                return "bestGII";
              } else if (val < 0.1) {
                return "greatGII";
              } else if (val < 0.3) {
                return "averageGII";
              } else if (val < 0.4) {
                return "badGII";
              } else {
                return "worstGII";
              }
            }
          }
        return "none";});



        g.append("path")
        .datum(topojson.mesh(world, world.objects.countries, function(a, b) { return a !== b; }))
        .attr("id", "country-borders")
        .attr("d", path);

      });

      var legendRectSize = 18;
      var legendSpacing = 4;
      var colors = ["#FF0000", "#FF9000", "#D0FF00", "#80FF00", "#00FF00", "#000000"];
      var colorNames = ["Worst", "Bad", "Average", "Great", "Best", "No Data"];

      var legend = svg.selectAll('.legend')
      .data(colors)
      .enter()
      .append('g')
      .attr('class', 'legend')
      .attr('transform', 'translate(50,400)');


      for (var i = 0; i < colors.length; i ++){
      legend.append('rect')
      .attr('width', legendRectSize)
      .attr('height', legendRectSize-legendSpacing)
      .attr('x', legendRectSize + legendSpacing)
      .attr('y', legendRectSize - legendSpacing + 20*i)
      .style('fill', colors[i])
      .style('stroke', colors[i]);

      legend.append('text')
      .attr('x', legendRectSize + legendSpacing*7)
      .attr('y', legendRectSize + legendSpacing*2 + 20*i)
      .text(colorNames[i]);
      }

     }

     function loadGIIGraph(){
       var mainCountries = ["Netherlands","Switzerland", "Germany", "United Kingdom", "Japan", "United States", "China", "Russia", "Brazil"];
       var values = mainCountries.map(function(d){
         return gii[d];
       });

       var width = 500,
       height = 900,
       padding = 25;

       var xscale = d3.scale.linear()
       .domain([0,1])
       .range([padding, width-padding]);

       var yscale = d3.scale.linear()
       .domain([0,mainCountries.length])
       .range([height-padding, padding]);

       var colors = ['#0000b4','#0082ca','#0094ff','#0d4bcf','#0066AE','#074285','#00187B','#285964','#405F83','#416545','#4D7069','#6E9985','#7EBC89','#0283AF','#79BCBF','#99C19E'];

       var colorScale = d3.scale.quantize()
       .domain([0,mainCountries.length])
       .range(colors);

       var canvas = d3.select('#middlegraph')
       .append('svg')
       .attr({'width':500,'height':900});

       var grids = canvas.append('g')
       .attr('id','grid')
       .attr('transform','translate(150,10)')
       .selectAll('line')
       .data(grid)
       .enter()
       .append('line')
       .attr({'x1':function(d,i){ return i*30; },
         'y1':function(d){ return d.y1; },
         'x2':function(d,i){ return i*30; },
         'y2':function(d){ return d.y2; },
       })
       .style({'stroke':'#adadad','stroke-width':'1px'});


       var chart = canvas.append('g')
       .attr("transform", "translate(150,0)")
       .attr('id','bars')
       .selectAll('rect')
       .data(values)
       .enter()
       .append('rect')
       .attr('height',19)
       .attr({'x':0,'y':function(d,i){ return yscale(i)+19; }})
       .style('fill',function(d,i){ return colorScale(i); })
       .attr('width',function(d){ return 0; });

     }

    </script>

  <script>
    $(document).on('click', '.toggle-button', function() {
        if (!showAllCountries) {
        console.log("Turning On");
          showAllCountries = true;
          savedPreviously = clickedPreviously;
          clickedPreviously = Object.keys(idMap).map(function(d){return Number(d);});
          var tempCentered = centered;
          if (!centered) {
            centered = null;
            clicked({"id":840});
          } else {
            centered = null;
            clicked(tempCentered);
          }
        } else {
          console.log("Turning Off");
          showAllCountries = false;
          clickedPreviously = savedPreviously;

          var tempCentered = centered;
          if (!centered) {
            clicked({"id":840});
          } else {
            centered = null;
            clicked(tempCentered);
          }
        }
          $(this).toggleClass('toggle-button-selected');
        });
  </script>
  </body>
</html>
